a<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skoki Narciarskie - Fantasy Draft Online</title>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f4f8; }
        
        .jumper-card { transition: all 0.2s; }
        .jumper-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .jumper-card.disabled { opacity: 0.5; filter: grayscale(100%); cursor: not-allowed; transform: none; box-shadow: none; }
        .jumper-card.my-turn:hover { border-color: #3b82f6; ring: 2px solid #3b82f6; }
        
        .team-box { transition: all 0.3s ease-in-out; }
        .active-turn { ring: 4px solid #3b82f6; transform: scale(1.02); z-index: 10; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .jumper-list::-webkit-scrollbar { width: 8px; }
        .jumper-list::-webkit-scrollbar-track { background: #f1f1f1; }
        .jumper-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .jumper-list::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast { animation: slideIn 0.3s ease-out forwards; }
        
        .request-alert { animation: pulse-border 2s infinite; }
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, updateDoc, arrayUnion, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- KONFIGURACJA (DLA GITHUB/W≈ÅASNEGO SERWERA) ---
        // Aby strona dzia≈Ça≈Ça na GitHub Pages, wklej poni≈ºej obiekt konfiguracyjny ze swojego projektu Firebase.
        // Instrukcja: Firebase Console -> Project Settings -> General -> Your apps -> SDK setup and configuration -> Config
const customConfig = {
  apiKey: "AIzaSyAL1X0Tl5NocOjqqqIv-SewSKLxRyZ31_M",
  authDomain: "skoki-draft.firebaseapp.com",
  projectId: "skoki-draft",
  storageBucket: "skoki-draft.firebasestorage.app",
  messagingSenderId: "924643436062",
  appId: "1:924643436062:web:075af64db6eb796175f00f",
  measurementId: "G-3YM0YNPRW3"
};
        // Przyk≈Çad:
        // const customConfig = {
        //   apiKey: "AIzaSy...",
        //   authDomain: "twoj-projekt.firebaseapp.com",
        //   projectId: "twoj-projekt",
        //   storageBucket: "twoj-projekt.appspot.com",
        //   messagingSenderId: "...",
        //   appId: "..."
        // };

        // Logika wyboru konfiguracji
        let firebaseConfig;
        let currentAppId = 'default-app-id';

        if (customConfig) {
            firebaseConfig = customConfig;
            currentAppId = 'custom-app';
        } else if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            if (typeof __app_id !== 'undefined') currentAppId = __app_id;
        } else {
            console.warn("Brak konfiguracji Firebase. Aplikacja mo≈ºe nie dzia≈Çaƒá poza ≈õrodowiskiem testowym.");
        }

        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // Eksport do window, aby React m√≥g≈Ç korzystaƒá
            window.db = db;
            window.auth = auth;
            window.appId = currentAppId;
            window.signInAnonymously = signInAnonymously;
            window.signInWithCustomToken = signInWithCustomToken;
            window.onAuthStateChanged = onAuthStateChanged;
            window.doc = doc;
            window.setDoc = setDoc;
            window.getDoc = getDoc;
            window.onSnapshot = onSnapshot;
            window.updateDoc = updateDoc;
            window.arrayUnion = arrayUnion;
            window.runTransaction = runTransaction;
            
            // Flaga gotowo≈õci
            window.isFirebaseReady = true;
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- IKONY SVG ---
        const IconChevronUp = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m18 15-6-6-6 6"/></svg>;
        const IconChevronDown = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>;
        const IconUndo = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/></svg>;
        const IconDownload = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>;
        const IconReset = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>;
        const IconAlert = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-red-600"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>;
        const IconCheck = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>;
        const IconX = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>;

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Crash:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return <div className="p-4 text-center"><h1 className="text-red-600 font-bold">B≈ÇƒÖd aplikacji</h1><p>{this.state.error?.message}</p><button onClick={()=>window.location.reload()} className="bg-blue-600 text-white px-4 py-2 rounded mt-4">Od≈õwie≈º</button></div>;
                }
                return this.props.children;
            }
        }

        // --- DANE ---
        const COUNTRY_ISO = { 'AUT': 'at', 'GER': 'de', 'SLO': 'si', 'NOR': 'no', 'POL': 'pl', 'JPN': 'jp', 'SUI': 'ch', 'FIN': 'fi', 'ITA': 'it', 'USA': 'us', 'EST': 'ee', 'BUL': 'bg', 'UKR': 'ua', 'TUR': 'tr', 'FRA': 'fr', 'ROU': 'ro', 'CAN': 'ca', 'KAZ': 'kz' };
        const getFlagUrl = (country3) => `https://flagcdn.com/w40/${COUNTRY_ISO[country3] || 'xx'}.png`;

        const INITIAL_JUMPERS = [
            { id: 1, name: "Clemens Aigner", country: "AUT" }, { id: 2, name: "Niklas Bachlinger", country: "AUT" }, { id: 3, name: "Stephan Embacher", country: "AUT" }, { id: 4, name: "Manuel Fettner", country: "AUT" }, { id: 5, name: "Jan Hoerl", country: "AUT" }, { id: 6, name: "Daniel Huber", country: "AUT" }, { id: 7, name: "Stefan Kraft", country: "AUT" }, { id: 8, name: "Clemens Leitner", country: "AUT" }, { id: 9, name: "Maximilian Ortner", country: "AUT" }, { id: 10, name: "Jonas Schuster", country: "AUT" }, { id: 11, name: "Daniel Tschofenig", country: "AUT" }, { id: 12, name: "Philipp Aschenwald", country: "AUT" },
			{ id: 13, name: "W≈Çadimir Zografski", country: "BUL" },
			{ id: 14, name: "Roman Koudelka", country: "CZ" },
			{ id: 15, name: "Artti Aigro", country: "EST" }, { id: 16, name: "Kaimar Vagul", country: "EST" },
			{ id: 17, name: "Antti Aalto", country: "FIN" }, { id: 18, name: "Niko Kytosaho", country: "FIN" }, { id: 19, name: "Eetu Nousiainen", country: "FIN" }, { id: 20, name: "Kasperi Valto", country: "FIN" },
			{ id: 21, name: "Valentin Foubert", country: "FRA" }, { id: 22, name: "Enzo Milesi", country: "FRA" },
			{ id: 23, name: "Ryoyu Kobayashi", country: "JPN" }, { id: 24, name: "Sakutaro Kobayashi", country: "JPN" }, { id: 25, name: "Tomofumi Naito", country: "JPN" }, { id: 26, name: "Naoki Nakamura", country: "JPN" }, { id: 27, name: "Ren Nikaido", country: "JPN" }, { id: 28, name: "Junshir≈ç Kobayashi", country: "JPN" },  { id: 29, name: "Keiichi Sato", country: "JPN" }, { id: 30, name: "Yukiya Sato", country: "JPN" },
			{ id: 31, name: "Mackenzie Boyd-Clowes", country: "CAN" },
			{ id: 32, name: "Dani≈Ç Wasiljew", country: "KAZ" }
            { id: 33, name: "Karl Geiger", country: "GER" }, { id: 34, name: "Felix Hoffmann", country: "GER" }, { id: 35, name: "Pius Paschke", country: "GER" }, { id: 36, name: "Philipp Raimund", country: "GER" }, { id: 37, name: "Luca Roth", country: "GER" }, { id: 38, name: "Constantin Schmid", country: "GER" }, { id: 39, name: "Adrian Tittel", country: "GER" }, { id: 40, name: "Andreas Wellinger", country: "GER" },  
            { id: 41, name: "Johann Andre Forfang", country: "NOR" }, { id: 42, name: "Halvor Egner Granerud", country: "NOR" }, { id: 43, name: "Bendik Jakobsen Heggli", country: "NOR" }, { id: 44, name: "Marius Lindvik", country: "NOR" }, { id: 45, name: "Benjamin Oestvold", country: "NOR" }, { id: 46, name: "Robin Pedersen", country: "NOR" }, { id: 47, name: "Kristoffer Eriksen Sundal", country: "NOR" }, { id: 48, name: "Fredrik Villumstad", country: "NOR" },
            { id: 49, name: "Maciej Kot", country: "POL" }, { id: 50, name: "Dawid Kubacki", country: "POL" }, { id: 51, name: "Kamil Stoch", country: "POL" }, { id: 52, name: "Kacper Tomasiak", country: "POL" }, { id: 53, name: "Pawe≈Ç WƒÖsek", country: "POL" }, { id: 54, name: "Jakub Wolny", country: "POL" }, { id: 55, name: "Aleksander Zniszczo≈Ç", country: "POL" }, { id: 56, name: "Piotr ≈ªy≈Ça", country: "POL" },
			{ id: 57, name: "Daniel Andrei Cacina", country: "ROU" },			
            { id: 58, name: "Enej Faletic", country: "SLO" }, { id: 59, name: "Ziga Jancar", country: "SLO" }, { id: 60, name: "Ziga Jelar", country: "SLO" }, { id: 61, name: "Lovro Kos", country: "SLO" }, { id: 62, name: "Anze Lanisek", country: "SLO" }, { id: 63, name: "Rok Oblak", country: "SLO" }, { id: 64, name: "Domen Prevc", country: "SLO" }, { id: 65, name: "Timi Zajc", country: "SLO" },   
            { id: 66, name: "Simon Ammann", country: "SUI" }, { id: 67, name: "Gregor Deschwanden", country: "SUI" }, { id: 68, name: "Sandro Hauswirth", country: "SUI" }, { id: 69, name: "Juri Kesseli", country: "SUI" }, { id: 70, name: "Killian Peier", country: "SUI" }, { id: 71, name: "Felix Trunz", country: "SUI" }, { id: 72, name: "Remo Imhof", country: "SUI" },
			{ id: 73, name: "Fatih Arda Ipcioglu", country: "TUR" },
			{ id: 74, name: "Yevhen Marusiak", country: "UKR" }, 			
            { id: 75, name: "Erik Belshaw", country: "USA" }, { id: 76, name: "Kevin Bickner", country: "USA" }, { id: 77, name: "Jason Colby", country: "USA" }, { id: 78, name: "Tate Frantz", country: "USA" }, { id: 79, name: "Andrew Urlaub", country: "USA" },
			{ id: 80, name: "Giovanni Bresadola", country: "ITA" }, { id: 81, name: "Alex Insam", country: "ITA" }, { id: 82, name: "Andrea Campregher", country: "ITA" },     
        ];

        const ROBUST_ROUNDS = 6;
        
        const DEFAULT_STATE = {
            hostId: null,
            players: [], 
            selections: {},
            currentTurnIndex: 0,
            isDraftStarted: false,
            history: [],
            undoRequest: null // { playerId, playerName }
        };

        // Helper do ≈õcie≈ºki
        const getRoomDocRef = (roomName) => {
             const safeName = roomName.trim().toLowerCase().replace(/[^a-z0-9-_]/g, '');
             // Obs≈Çuga w≈Çasnego hostingu
             const collectionName = (window.appId === 'custom-app') ? 'draft_rooms' : 'rooms';
             // Je≈õli nie jeste≈õmy w ≈õrodowisku Google (brak appId), te≈º u≈ºyj prostej ≈õcie≈ºki
             if (!window.appId) {
                 return window.doc(window.db, 'draft_rooms', `room_${safeName}`);
             }
             // ≈öcie≈ºka dla ≈õrodowiska podglƒÖdu
             if (window.appId === 'default-app-id' || window.appId.startsWith('canvas')) {
                 return window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'rooms', `room_${safeName}`);
             }
             // Domy≈õlna prosta ≈õcie≈ºka
             return window.doc(window.db, 'draft_rooms', `room_${safeName}`);
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [roomName, setRoomName] = useState("");
            const [isJoined, setIsJoined] = useState(false);
            const [localName, setLocalName] = useState("");
            const [loading, setLoading] = useState(true);
            const [errorMsg, setErrorMsg] = useState(null);
            const [toastMsg, setToastMsg] = useState(null);

            const [gameState, setGameState] = useState(DEFAULT_STATE);
            const [searchTerm, setSearchTerm] = useState('');
            const prevPlayersLength = useRef(0);

            // 1. Auth Logic
            useEffect(() => {
                if (!window.auth) {
                    setErrorMsg("Brak konfiguracji Firebase.");
                    setLoading(false);
                    return;
                }

                const initAuth = async () => {
                    try {
                        // Pr√≥ba logowania anonimowego (najbardziej uniwersalna)
                        await window.signInAnonymously(window.auth);
                    } catch (err) {
                        console.error("Auth error:", err);
                        // Je≈õli anonimowe nie dzia≈Ça, sprawd≈∫ czy jest token (tylko w podglƒÖdzie)
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            try {
                                await window.signInWithCustomToken(window.auth, __initial_auth_token);
                            } catch (e) {
                                setErrorMsg("B≈ÇƒÖd logowania. Sprawd≈∫ konsolƒô.");
                            }
                        } else {
                            setErrorMsg("B≈ÇƒÖd logowania. W≈ÇƒÖcz 'Anonymous Auth' w konsoli Firebase.");
                        }
                    }
                    setLoading(false);
                };
                initAuth();
                return window.onAuthStateChanged(window.auth, (u) => setUser(u));
            }, []);

            // 2. Sync
            useEffect(() => {
                if (!user || !isJoined || !roomName) return;
                const docRef = getRoomDocRef(roomName);
                const unsub = window.onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setGameState({ ...DEFAULT_STATE, ...data });
                    }
                }, (err) => {
                    console.error("Sync error:", err);
                    setErrorMsg("Problem z po≈ÇƒÖczeniem.");
                });
                return () => unsub();
            }, [user, isJoined, roomName]);

            // 3. Powiadomienie
            useEffect(() => {
                if (!user || !isJoined) return;
                const isHost = user.uid === gameState.hostId;
                const currentCount = gameState.players ? gameState.players.length : 0;
                if (isHost && currentCount > prevPlayersLength.current && prevPlayersLength.current > 0) {
                    setToastMsg("Nowy gracz do≈ÇƒÖczy≈Ç!");
                    setTimeout(() => setToastMsg(null), 3000);
                }
                prevPlayersLength.current = currentCount;
            }, [gameState.players, gameState.hostId, user, isJoined]);

            // Logika
            const turnOrder = useMemo(() => {
                const players = gameState.players || [];
                if (players.length === 0) return [];
                const order = [];
                for (let round = 0; round < ROBUST_ROUNDS; round++) {
                    const roundOrder = players.map(p => p.id);
                    if (round % 2 !== 0) roundOrder.reverse();
                    order.push(...roundOrder);
                }
                return order;
            }, [gameState.players]);

            const currentPlayerId = turnOrder[gameState.currentTurnIndex];
            const currentPlayer = (gameState.players || []).find(p => p.id === currentPlayerId);
            const isDraftComplete = gameState.currentTurnIndex >= turnOrder.length;
            const isMyTurn = !isDraftComplete && currentPlayerId === user?.uid;
            const isHost = user?.uid === gameState.hostId;

            const updateState = async (newState) => {
                const docRef = getRoomDocRef(roomName);
                await window.updateDoc(docRef, newState);
            };

            // JOIN / RECOVERY
            const joinRoom = async () => {
                if (!roomName.trim() || !localName.trim()) return;
                const docRef = getRoomDocRef(roomName);
                
                try {
                    await window.runTransaction(window.db, async (transaction) => {
                        const docSnap = await transaction.get(docRef);
                        
                        if (!docSnap.exists()) {
                            const newState = {
                                ...DEFAULT_STATE,
                                hostId: user.uid,
                                players: [{ id: user.uid, name: localName }]
                            };
                            transaction.set(docRef, newState);
                        } else {
                            const data = docSnap.data();
                            const currentPlayers = data.players || [];
                            if (currentPlayers.length >= 10) throw new Error("Pok√≥j pe≈Çny");

                            const normalizedName = localName.trim().toLowerCase();
                            const existingPlayerIndex = currentPlayers.findIndex(p => p.name.toLowerCase() === normalizedName);

                            if (existingPlayerIndex !== -1) {
                                const newPlayers = [...currentPlayers];
                                newPlayers[existingPlayerIndex] = { ...newPlayers[existingPlayerIndex], id: user.uid, name: localName };
                                transaction.update(docRef, { players: newPlayers });
                            } else {
                                if (!data.isDraftStarted) {
                                    const newPlayers = [...currentPlayers, { id: user.uid, name: localName }];
                                    transaction.update(docRef, { players: newPlayers });
                                }
                            }
                        }
                    });
                    setIsJoined(true);
                } catch (e) {
                    console.error("Join error:", e);
                    alert("B≈ÇƒÖd: " + e.message);
                }
            };

            const movePlayer = async (index, direction) => {
                if (!isHost) return;
                const newPlayers = [...gameState.players];
                if (index + direction < 0 || index + direction >= newPlayers.length) return;
                const temp = newPlayers[index];
                newPlayers[index] = newPlayers[index + direction];
                newPlayers[index + direction] = temp;
                await updateState({ players: newPlayers });
            };

            const startDraft = async () => {
                if (!isHost) return;
                if (gameState.players.length < 1) return alert("Za ma≈Ço graczy!"); 
                await updateState({ isDraftStarted: true });
            };

            const selectJumper = async (jumper) => {
                if (!isMyTurn || gameState.selections[jumper.id]) return;
                const newHistory = [...gameState.history, {
                    selections: gameState.selections,
                    currentTurnIndex: gameState.currentTurnIndex
                }];
                await updateState({
                    selections: { ...gameState.selections, [jumper.id]: user.uid },
                    currentTurnIndex: gameState.currentTurnIndex + 1,
                    history: newHistory
                });
            };

            const requestUndo = async () => {
                if (gameState.history.length === 0) return;
                await updateState({
                    undoRequest: { playerId: user.uid, playerName: localName }
                });
            };

            const approveUndo = async () => {
                if (gameState.history.length === 0) return;
                const lastState = gameState.history[gameState.history.length - 1];
                const newHistory = gameState.history.slice(0, -1);
                await updateState({
                    selections: lastState.selections,
                    currentTurnIndex: lastState.currentTurnIndex,
                    history: newHistory,
                    undoRequest: null
                });
            };

            const rejectUndo = async () => {
                await updateState({ undoRequest: null });
            };
            
            const resetRoom = async () => {
                if (!isHost) return;
                if (confirm("Czy na pewno zresetowaƒá grƒô?")) {
                    await updateState({
                        selections: {},
                        currentTurnIndex: 0,
                        isDraftStarted: false,
                        history: [],
                        undoRequest: null
                    });
                }
            };

            const exportImage = (elementId, filename) => {
                const el = document.getElementById(elementId);
                if (el) {
                    html2canvas(el, { backgroundColor: "#ffffff", useCORS: true }).then(c => {
                        const l = document.createElement('a');
                        l.download = `${filename}_${roomName}.png`;
                        l.href = c.toDataURL();
                        l.click();
                    });
                }
            };

            const getFilteredJumpers = () => {
                if (!searchTerm) return INITIAL_JUMPERS;
                const lower = searchTerm.toLowerCase();
                return INITIAL_JUMPERS.filter(j => j.name.toLowerCase().includes(lower) || j.country.toLowerCase().includes(lower));
            };

            // --- RENDER ---
            if (loading) return <div className="min-h-screen flex items-center justify-center"><div className="loader"></div></div>;
            
            if (!isJoined) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                        <div className="bg-white p-8 rounded-xl shadow-lg max-w-md w-full text-center">
                            <h1 className="text-4xl mb-4">‚õ∑Ô∏è</h1>
                            <h2 className="text-2xl font-bold text-slate-800 mb-6">Do≈ÇƒÖcz do Gry</h2>
                            
                            {/* Miejsce na komunikat dla GitHub */}
                            {(!window.appId || window.appId === 'default-app-id') && typeof __firebase_config === 'undefined' && (
                                <div className="mb-4 p-2 bg-yellow-100 text-yellow-800 text-sm rounded">
                                    <b>Uwaga:</b> Skonfiguruj Firebase w pliku HTML, aby gra dzia≈Ça≈Ça.
                                </div>
                            )}

                            <div className="space-y-4">
                                <input className="w-full p-3 border rounded-lg" placeholder="Tw√≥j Nick" value={localName} onChange={e => setLocalName(e.target.value)} />
                                <input className="w-full p-3 border rounded-lg uppercase" placeholder="Nazwa Pokoju (np. SKOKI1)" value={roomName} onChange={e => setRoomName(e.target.value)} />
                                <button onClick={joinRoom} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700" disabled={!localName || !roomName}>Wejd≈∫</button>
                            </div>
                        </div>
                    </div>
                );
            }

            // WIDOK: LOBBY
            if (!gameState.isDraftStarted) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                        {toastMsg && <div className="toast fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded shadow-lg z-50">{toastMsg}</div>}
                        <div className="bg-white p-6 rounded-xl shadow-xl w-full max-w-lg">
                            <h1 className="text-2xl font-bold text-center mb-2 text-slate-800">Poczekalnia Lobby</h1>
                            <p className="text-center text-slate-500 mb-6">Pok√≥j: <span className="font-mono font-bold text-blue-600">{roomName.toUpperCase()}</span></p>
                            <div className="mb-6">
                                <h3 className="font-bold text-gray-700 mb-3 flex justify-between items-center">
                                    <span>Lista Graczy ({gameState.players ? gameState.players.length : 0})</span>
                                    {isHost && <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Ustal kolejno≈õƒá ‚ñº</span>}
                                </h3>
                                <ul className="space-y-2 max-h-80 overflow-y-auto pr-1">
                                    {(gameState.players || []).map((player, index) => (
                                        <li key={player.id} className={`flex items-center justify-between p-3 rounded-lg border ${player.id === user.uid ? 'bg-blue-50 border-blue-200' : 'bg-gray-50 border-gray-100'}`}>
                                            <div className="flex items-center gap-3">
                                                <span className="font-bold text-slate-400 w-6">{index + 1}.</span>
                                                <span className="font-medium text-slate-800">{player.name} {player.id === user.uid && "(Ty)"} {player.id === gameState.hostId && "üëë"}</span>
                                            </div>
                                            {isHost && (
                                                <div className="flex gap-1">
                                                    <button onClick={() => movePlayer(index, -1)} disabled={index === 0} className="p-1 hover:bg-blue-200 rounded text-blue-600 disabled:opacity-30"><IconChevronUp /></button>
                                                    <button onClick={() => movePlayer(index, 1)} disabled={index === gameState.players.length - 1} className="p-1 hover:bg-blue-200 rounded text-blue-600 disabled:opacity-30"><IconChevronDown /></button>
                                                </div>
                                            )}
                                        </li>
                                    ))}
                                </ul>
                            </div>
                            {isHost ? (
                                <button onClick={startDraft} disabled={(gameState.players || []).length < 1} className="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 shadow-md disabled:bg-gray-300">Rozpocznij Draft</button>
                            ) : (
                                <div className="text-center p-4 bg-gray-50 rounded-lg text-gray-500 animate-pulse border border-gray-200">Oczekiwanie na Hosta...</div>
                            )}
                        </div>
                    </div>
                );
            }

            // WIDOK: PODSUMOWANIE
            if (isDraftComplete) {
                return (
                    <div className="min-h-screen p-4 md:p-8 max-w-7xl mx-auto">
                        <header className="mb-6 flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                            <div>
                                <h1 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><span className="text-3xl">üèÜ</span> Draft Zako≈Ñczony!</h1>
                                <div className="text-sm text-slate-500 mt-1">Pok√≥j: {roomName.toUpperCase()}</div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => exportImage('summary-board', 'wyniki')} className="bg-green-600 text-white px-6 py-2 rounded font-bold hover:bg-green-700 shadow-md flex items-center gap-2"><IconDownload /> Zapisz</button>
                                {isHost && <button onClick={resetRoom} className="px-4 py-2 text-red-600 hover:bg-red-50 rounded border border-red-200 flex items-center gap-1 font-medium ml-2"><IconReset /> Nowa Gra</button>}
                            </div>
                        </header>
                        <div id="summary-board" className="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                            <div className="text-center mb-6 pb-4 border-b border-slate-100">
                                <h2 className="text-3xl font-bold text-slate-800">OFICJALNE SK≈ÅADY</h2>
                                <p className="text-slate-400 text-sm">Fantasy Draft Skoki Narciarskie</p>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {gameState.players.map(player => {
                                    const playerJumpers = INITIAL_JUMPERS.filter(j => gameState.selections[j.id] === player.id);
                                    return (
                                        <div key={player.id} className="bg-slate-50 rounded-lg border border-slate-200 overflow-hidden">
                                            <div className="bg-slate-800 text-white p-3 text-center font-bold text-lg">{player.name}</div>
                                            <ul className="p-4 space-y-3">
                                                {playerJumpers.map((j, idx) => (
                                                    <li key={j.id} className="flex items-center gap-3 text-sm bg-white p-2 rounded border border-slate-100 shadow-sm">
                                                        <img src={getFlagUrl(j.country)} alt={j.country} className="w-6 h-4 object-cover rounded-sm shadow-sm" />
                                                        <span className="font-semibold text-slate-700 flex-grow">{j.name}</span>
                                                        {idx === 5 && <span className="text-[10px] font-bold text-white bg-orange-500 px-2 py-0.5 rounded-full">REZ</span>}
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                );
            }

            // WIDOK: GRA (DRAFT)
            return (
                <div className="min-h-screen p-4 md:p-8 max-w-7xl mx-auto relative">
                    {isHost && gameState.undoRequest && (
                        <div className="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 bg-white rounded-lg shadow-2xl border-2 border-red-500 p-4 flex flex-col items-center gap-3 request-alert">
                            <div className="flex items-center gap-2 text-red-600 font-bold">
                                <IconAlert />
                                <span>Gracz {gameState.undoRequest.playerName} prosi o cofniƒôcie!</span>
                            </div>
                            <div className="flex gap-2 w-full">
                                <button onClick={approveUndo} className="flex-1 bg-green-600 text-white py-2 rounded hover:bg-green-700 font-bold flex justify-center items-center gap-1"><IconCheck /> Tak</button>
                                <button onClick={rejectUndo} className="flex-1 bg-gray-200 text-gray-700 py-2 rounded hover:bg-gray-300 font-bold flex justify-center items-center gap-1"><IconX /> Nie</button>
                            </div>
                        </div>
                    )}

                    {toastMsg && <div className="toast fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded shadow-lg z-50">{toastMsg}</div>}
                    <header className="mb-6 flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                        <div>
                            <h1 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><span className="text-3xl">‚õ∑Ô∏è</span> Fantasy Draft</h1>
                            <div className="flex gap-2 text-sm mt-1">
                                <span className="bg-blue-100 text-blue-800 px-2 py-0.5 rounded">Pok√≥j: {roomName.toUpperCase()}</span>
                                <span className="bg-gray-100 text-gray-800 px-2 py-0.5 rounded">Ty: {localName}</span>
                                {isHost && <span className="bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded">HOST</span>}
                            </div>
                        </div>
                        <div className="flex gap-2">
                            {(gameState.isDraftStarted || gameState.history.length > 0) && (
                                <>
                                    {isHost ? (
                                        <button onClick={approveUndo} className="px-3 py-2 border rounded hover:bg-gray-50 flex items-center gap-1 text-sm text-slate-700"><IconUndo /> Cofnij (Host)</button>
                                    ) : (
                                        <button 
                                            onClick={requestUndo} 
                                            disabled={!!gameState.undoRequest} 
                                            className={`px-3 py-2 border rounded flex items-center gap-1 text-sm ${gameState.undoRequest?.playerId === user.uid ? 'bg-yellow-100 text-yellow-800' : 'hover:bg-gray-50 text-slate-700'}`}
                                        >
                                            <IconUndo /> {gameState.undoRequest?.playerId === user.uid ? "Czekam..." : "Popro≈õ o cofniƒôcie"}
                                        </button>
                                    )}
                                    <button onClick={() => exportImage('teams-container', 'skoki')} className="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center gap-1 text-sm shadow-sm"><IconDownload /> Obraz</button>
                                </>
                            )}
                            {isHost && <button onClick={resetRoom} className="px-3 py-2 text-red-600 hover:bg-red-50 rounded border border-transparent hover:border-red-200 flex items-center gap-1 text-sm ml-2"><IconReset /> Reset</button>}
                        </div>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        <div className="lg:col-span-7 xl:col-span-8">
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 h-[calc(100vh-200px)] flex flex-col">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="font-bold text-slate-700">Dostƒôpni Skoczkowie</h2>
                                    <input type="text" placeholder="Szukaj..." className="border p-2 rounded-lg text-sm w-48" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                                </div>
                                <div className="jumper-list flex-grow overflow-y-auto pr-2 pb-2">
                                    <div className="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3">
                                        {getFilteredJumpers().map(jumper => {
                                            const isTaken = gameState.selections[jumper.id];
                                            let cardClass = "jumper-card p-3 rounded-lg border flex flex-col items-center text-center cursor-pointer select-none relative overflow-hidden bg-white border-slate-200";
                                            if (isTaken) {
                                                cardClass = "jumper-card p-3 rounded-lg border flex flex-col items-center text-center select-none relative overflow-hidden bg-slate-50 border-slate-100 disabled";
                                            } else if (isMyTurn) {
                                                cardClass += " hover:border-blue-400 my-turn";
                                            }
                                            return (
                                                <div key={jumper.id} onClick={() => selectJumper(jumper)} className={cardClass}>
                                                    <img src={getFlagUrl(jumper.country)} alt={jumper.country} className="w-8 h-6 object-cover mb-2 shadow-sm rounded-sm" crossOrigin="anonymous" />
                                                    <span className={`font-semibold text-sm ${isTaken ? 'line-through text-slate-400' : 'text-slate-800'}`}>{jumper.name}</span>
                                                    <span className="text-xs text-slate-400 font-mono">{jumper.country}</span>
                                                    {isTaken && <div className="absolute inset-0 flex items-center justify-center bg-slate-200/20"><span className="text-red-500 font-bold text-4xl opacity-40">‚úï</span></div>}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="lg:col-span-5 xl:col-span-4 flex flex-col gap-4">
                            {!isDraftComplete && (
                                <div className="bg-blue-600 text-white p-4 rounded-xl shadow-lg text-center sticky top-4 z-20 border border-blue-700">
                                    <div className="text-xs uppercase opacity-80 font-semibold tracking-wide mb-1">Runda {Math.floor(gameState.currentTurnIndex / gameState.players.length) + 1} / 6</div>
                                    <div className="text-2xl font-bold flex flex-col items-center">
                                        <span className="text-sm font-normal opacity-90">Teraz wybiera:</span>
                                        <span className="text-3xl mt-1">{currentPlayer ? currentPlayer.name : "..."} {isMyTurn && "(Ty!)"}</span>
                                    </div>
                                </div>
                            )}
                            <div id="teams-container" className="bg-slate-100 p-4 rounded-xl border border-slate-200 flex flex-col gap-4 max-h-[calc(100vh-300px)] overflow-y-auto">
                                <div className="text-center pb-2 border-b border-slate-300 mb-2"><h2 className="font-bold text-lg text-slate-600">SK≈ÅADY DRU≈ªYN</h2></div>
                                {gameState.players.map(player => {
                                    const playerJumpers = INITIAL_JUMPERS.filter(j => gameState.selections[j.id] === player.id);
                                    const isCurrent = !isDraftComplete && currentPlayer?.id === player.id;
                                    return (
                                        <div key={player.id} className={`team-box bg-white p-4 rounded-lg shadow-sm border ${isCurrent ? 'border-blue-500 ring-2 ring-blue-100' : 'border-slate-200'}`}>
                                            <div className="flex justify-between items-center mb-3 border-b pb-2">
                                                <h3 className="font-bold text-lg text-slate-800">{player.name}</h3>
                                                <span className="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500">{playerJumpers.length}/6</span>
                                            </div>
                                            <ul className="space-y-2">
                                                {playerJumpers.map((j, idx) => (
                                                    <li key={j.id} className="flex items-center gap-2 text-sm">
                                                        <img src={getFlagUrl(j.country)} alt={j.country} className="w-6 h-4 object-cover shadow-sm rounded-sm" crossOrigin="anonymous" />
                                                        <span className="font-medium text-slate-700">{j.name}</span>
                                                        {idx === 5 && <span className="ml-auto text-[10px] uppercase font-bold text-orange-500 border border-orange-200 px-1 rounded">REZ</span>}
                                                    </li>
                                                ))}
                                                {Array.from({ length: 6 - playerJumpers.length }).map((_, i) => (
                                                    <li key={`e-${i}`} className="flex items-center gap-2 text-sm text-slate-300 italic border-b border-dashed border-slate-100 pb-1"><span className="text-lg opacity-50">üè≥Ô∏è</span><span>...</span></li>
                                                ))}
                                            </ul>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- FIX: Wait for Firebase ready event or poll before mounting React app to avoid race condition ---
        const startReact = () => {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<ErrorBoundary><App /></ErrorBoundary>);
        };

        // Simple polling to wait for Firebase initialization
        const waitForFirebase = () => {
            if (window.isFirebaseReady && window.onAuthStateChanged) {
                startReact();
            } else {
                setTimeout(waitForFirebase, 50);
            }
        };
        waitForFirebase();

    </script>
</body>

</html>


